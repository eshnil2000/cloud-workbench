# The following variables are available
# benchmark_name: Name of the benchmark definition from the web interface
# benchmark_name_sanitized: benchmark_name where all non-word-characters are replaced with an underscore '_'
# benchmark_id: The unique benchmark definition identifier
# execution_id: The unique benchmark execution identifier
# chef_node_name: The default node name used for Chef client provisioning
# tag_name: The default tag name set as aws name tag

Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
  config.vm.provider :aws do |aws, override|
    aws.region = 'eu-north-1'
    # Official Ubuntu from Canonical: https://cloud-images.ubuntu.com/locator/ec2/
    # 18.04 LTS hvm:ebs-ssd amd64 eu-north-1
    aws.ami = 'ami-780a8206'
    # https://www.ec2instances.info/
    # Options: t3.nano, t3.micro, t3.small
    aws.instance_type = 't3.nano'
  end

  config.vm.provision 'cwb', type: 'chef_client' do |chef|
    chef.add_recipe 'cli-benchmark'
    chef.json =
    {
      'cli-benchmark' => {
          'packages' => ['sysbench'],
          # 'pre_run' => 'echo "This runs immediately before execution" >> log.txt',
          'run' => 'sysbench --time=10 --cpu-max-prime=25000 cpu run',
          'repetitions' => 3,
          'metrics' => {
            # [name of the metric] => [regex to extract result from stdout],
            'execution_time' => 'total time:\s*(\d+\.\d+)s',
            'events_per_second' => 'events per second:\s*(\d+\.?\d*)'
          },
      },
    }
  end
end
